name: Trigger Webhook on Push

on:
  push:
    branches:
      - main

jobs:
  notify-webhook:
    runs-on: ubuntu-latest
    steps:
      - name: Send HMAC-signed webhook request
        env:
          DEPLOY_SECRET: ${{ secrets.DEPLOY_SECRET }}
          DEPLOY_DOMAIN: ${{ secrets.DEPLOY_DOMAIN }}
        run: |
          PAYLOAD='{"repository":"${{ github.repository }}","commit":"${{ github.sha }}"}'
          SIGNATURE=$(echo -n "$PAYLOAD" | openssl dgst -sha256 -hmac "$DEPLOY_SECRET" -hex | sed 's/^.* //')
          
          echo "Sending to: https://$DEPLOY_DOMAIN/hooks/tiny-stats"
          echo "Signature: $SIGNATURE"
          
          curl -X POST \
            -H "Content-Type: application/json" \
            -H "X-Hub-Signature-256: sha256=$SIGNATURE" \
            -d "$PAYLOAD" \
            -v \
            "https://$DEPLOY_DOMAIN/hooks/tiny-stats"
